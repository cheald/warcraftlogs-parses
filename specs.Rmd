---
title: "Rogue spec scaling"
output:
  html_notebook: 
    fig_height: 6
    fig_width: 18
  pdf_document: default
---

I was curious about the relative scaling potential of the three rogue specs. We know from sims that Assassination is king in the 850-880 range, and that Sub is expected to surpass it after that. Outlaw is not expected to scale as well as either of the other specs. I figured, why not look at the data and see what shakes out?

## Fetching the data

Data is grabbed from WarcraftLogs via their API. We get the top 1k parses per spec/encounter/difficulty.

Source is at https://github.com/cheald/warcraftlogs-parses

```
$ API_KEY=your_key_here ruby grabber.rb rogue
```

Once we have the JSON files, we use a small script to boil them down into a CSV:

```
$ API_KEY=your_key_here ruby distill.rb rogue
```

This results in the `csv/rogue.csv` that we then consume in R.

Once in R, we load it up:

```{r}
library(reshape2)
library(ggplot2)
library(dplyr)
data <- read.csv("csv/rogue.csv")
data$date <- as.Date(data$date)
cutoff_date = "2016-10-15"
```

## Filtering and plotting

Then we define a function that can be used to filter the dataset to a particular encounter and difficulty. It also performs outlier filtering - for each 5-ilvl bucket, for each spec, we compute the 95th percentile of DPS, then remove any parses from the dataset for that ilvl/spec above that cutoff.

```{r}

get_encounter_data <- function(encounter_name, difficulty_name, dataset, cutoff=c(0.05, 0.95), bucket_size=1, min_ilvl=855, max_ilvl=875) {
  specs <- unique(dataset$spec)
  d <- filter(dataset, ilvl >= min_ilvl, ilvl <= max_ilvl, encounter == encounter_name, difficulty == difficulty_name, date >= cutoff_date)
  for(bucket in seq(800, 900, by=bucket_size)) {
    for(f_spec in specs) {
      q <- quantile(d[d$spec == f_spec & d$ilvl >= bucket & d$ilvl < bucket + bucket_size,]$dps, cutoff)
      if(!is.na(q[1])) {
        d <- filter(d, !(spec == f_spec & ilvl >= bucket & ilvl < bucket + bucket_size & (dps > q[2] | dps < q[1])))
      }
    }
  }
  return(d)
}
```

Plotting the data is straightforward. Here we plot both boxplots for each spec/ilvl bucket, as well as a smoothed moving average and a linear trendline.

```{r}
plot_encounter <- function(encounter_name, difficulty_name, dataset=data, bucket_size=2, cutoff=c(0.05, 0.95)) {
  encounter_data <- get_encounter_data(encounter_name, difficulty_name, dataset=dataset, bucket_size=bucket_size, cutoff=cutoff)

  long_data <- melt(encounter_data, id.vars=c("spec", "ilvl"), measure.vars=c("dps"))

  p <- ggplot(data=long_data, aes(x=ilvl, group=spec, colour=spec, fill=spec)) + geom_bar(position="dodge") +
    labs(y="Parses", x="iLevel", title=paste("Parses:", encounter_name, difficulty_name))
  print(p)
  cat('\r\n\r\n')
  
  p <- ggplot(data=long_data, aes(x=ilvl, y=value, group=spec, colour=spec)) +
    geom_boxplot(aes(group=interaction(spec, floor(ilvl/bucket_size) * bucket_size))) +
    geom_smooth() + # loess fit
    geom_smooth(linetype = "dashed", method = "lm", se = FALSE) + # linear fit
    labs(y="DPS", x="iLevel", title=paste("Performance:", encounter_name, difficulty_name))
  print(p)
  cat('\r\n\r\n')
}
```

## Results

In general, this shows what we generally suspect: Assassination is the strongest rogue spec for prolonged single-target fights, while Outlaw is only preferable on heavy multi-target fights such as Il'gynoth.

```{r, fig.width=12, fig.height=6}

plot_encounter("nythendra", "Normal")
plot_encounter("nythendra", "Heroic")
plot_encounter("nythendra", "Mythic")

plot_encounter("ursoc", "Normal")
plot_encounter("ursoc", "Heroic")
plot_encounter("ursoc", "Mythic")

plot_encounter("elerethe_renferal", "Normal")
plot_encounter("elerethe_renferal", "Heroic")
plot_encounter("elerethe_renferal", "Mythic")

plot_encounter("il_gynoth__heart_of_corruption", "Normal")
plot_encounter("il_gynoth__heart_of_corruption", "Heroic")
plot_encounter("il_gynoth__heart_of_corruption", "Mythic")

plot_encounter("dragons_of_nightmare", "Normal")
plot_encounter("dragons_of_nightmare", "Heroic")
plot_encounter("dragons_of_nightmare", "Mythic")

plot_encounter("cenarius", "Normal")
plot_encounter("cenarius", "Heroic")
plot_encounter("cenarius", "Mythic")

plot_encounter("xavius", "Normal")
plot_encounter("xavius", "Heroic")
plot_encounter("xavius", "Mythic")
```

### Scaling

So we have the raw (smoothed) damage progressions, but how about scaling? Eyeballing the above, it looks like Assassination scales better, but we should look directly at how damage improves as ilvl increases.

```{r, fig.width=12, fig.height=6}
plot_dps_gain <- function(encounter, difficulty, dataset=data, bucket_size=1, cutoff=c(0.05, 0.95)) {
  d <- dataset[dataset$encounter == encounter & dataset$difficulty == difficulty & dataset$ilvl <= 870 & dataset$date >= cutoff_date, ]
  d <- aggregate(d$dps, by=list(ilvl=d$ilvl, spec=d$spec), FUN=mean)
  d$dps <- d$x
  d <- d[order(d$ilvl),]
  d$diff <- ave(d$dps, factor(d$spec), FUN=function(x) c(NA, diff(x)))
  d <- filter(d, !is.na(diff))
  ggplot(data=d, aes(x=ilvl, y=diff, group=interaction(spec, encounter), colour=spec)) + geom_smooth(se=FALSE, fullrange=TRUE) +
    labs(y="DPS gain per tier", x="iLevel", title=paste(encounter, difficulty, sep = " ")) + coord_cartesian(ylim = c(0, 15000))
}

# Commented fights have too little data to produce anything useful

plot_dps_gain("nythendra", "Normal")
plot_dps_gain("nythendra", "Heroic")
plot_dps_gain("nythendra", "Mythic")

plot_dps_gain("ursoc", "Normal")
plot_dps_gain("ursoc", "Heroic")
plot_dps_gain("ursoc", "Mythic")

plot_dps_gain("elerethe_renferal", "Normal")
plot_dps_gain("elerethe_renferal", "Heroic")
plot_dps_gain("elerethe_renferal", "Mythic")

plot_dps_gain("il_gynoth__heart_of_corruption", "Normal")
plot_dps_gain("il_gynoth__heart_of_corruption", "Heroic")
# plot_dps_gain("il_gynoth__heart_of_corruption", "Mythic")

plot_dps_gain("dragons_of_nightmare", "Normal")
plot_dps_gain("dragons_of_nightmare", "Heroic")
# plot_dps_gain("dragons_of_nightmare", "Mythic")

plot_dps_gain("cenarius", "Normal")
plot_dps_gain("cenarius", "Heroic")
# plot_dps_gain("cenarius", "Mythic")

plot_dps_gain("xavius", "Normal")
plot_dps_gain("xavius", "Heroic")
# plot_dps_gain("xavius", "Mythic")

```

## Conclusions

Overall, I would consider the hypothesis generally confirmed. Assassination clearly holds superior single-target potential to either Sub or Outlaw at the current level of raiding, barring the freak Outlaw parses with multiple 6-buff RtB rolls. Outlaw consistently scales less impressively than either Assassination or Subtlety as ilvl progresses.